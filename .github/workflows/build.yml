name: CGRU Build Matrix

on:
  pull_request:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: cgru-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-ubuntu:
    name: Build Ubuntu ${{ matrix.ubuntu }}
    runs-on: ubuntu-${{ matrix.ubuntu }}
    strategy:
      fail-fast: false
      matrix:
        ubuntu: ["22.04", "24.04"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential \
            cmake \
            git \
            libpq-dev \
            libzip-dev \
            python3 \
            python3-dev \
            qtbase5-dev \
            qtmultimedia5-dev

      - name: Build (SQL + GUI)
        working-directory: afanasy/src/project.cmake
        run: |
          set -euo pipefail
          ./clear.py
          ./build.sh --quiet -j"$(nproc)"

  build-linux-container:
    name: Build ${{ matrix.name }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Debian 11
            image: debian:11
          - name: Debian 12
            image: debian:12
          - name: Rocky 8
            image: rockylinux:8
          - name: Rocky 9
            image: rockylinux:9
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build In Container (SQL + GUI)
        run: |
          set -euo pipefail
          docker run --rm \
            -v "${GITHUB_WORKSPACE}:/src" \
            -w /src \
            "${{ matrix.image }}" \
            /bin/bash -lc '
              set -euo pipefail

              if command -v apt-get >/dev/null 2>&1; then
                export DEBIAN_FRONTEND=noninteractive
                apt-get update
                apt-get install -y \
                  build-essential \
                  cmake \
                  git \
                  libpq-dev \
                  libzip-dev \
                  python3 \
                  python3-dev \
                  qtbase5-dev \
                  qtmultimedia5-dev
              else
                dnf -y install dnf-plugins-core || true
                crb enable || dnf config-manager --set-enabled crb || true
                dnf -y install epel-release || true
                dnf -y makecache

                if ! dnf -y install \
                  cmake \
                  gcc \
                  gcc-c++ \
                  git \
                  libzip-devel \
                  make \
                  postgresql-devel \
                  python3 \
                  python3-devel \
                  qt5-qtbase-devel \
                  qt5-qtmultimedia-devel \
                  which; then
                  dnf -y install \
                    cmake \
                    gcc \
                    gcc-c++ \
                    git \
                    libzip5-devel \
                    make \
                    postgresql-devel \
                    python3 \
                    python3-devel \
                    qt5-qtbase-devel \
                    qt5-qtmultimedia-devel \
                    which
                fi
              fi

              cd /src/afanasy/src/project.cmake
              ./clear.py
              ./build.sh --quiet -j"$(nproc)"
            '

  build-windows:
    name: Build Windows 2019 (SQL + GUI)
    runs-on: windows-2019
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Restore Qt Cache
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: C:\Qt\5.15.2\msvc2019_64
          key: windows-2019-qt-5.15.2-msvc2019_64

      - name: Install Qt 5.15.2 (MSVC2019)
        if: steps.cache-qt.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip aqtinstall
          python -m aqt install-qt windows desktop 5.15.2 win64_msvc2019_64 -O C:\Qt

      - name: Export Qt Environment
        shell: pwsh
        run: |
          "QT_ROOT=C:\Qt\5.15.2\msvc2019_64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "C:\Qt\5.15.2\msvc2019_64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Prepare vcpkg
        shell: pwsh
        run: |
          if (Test-Path "C:\vcpkg\.git") {
            Write-Host "Using existing vcpkg checkout at C:\\vcpkg"
            git -C C:\vcpkg fetch --depth 1 origin
            git -C C:\vcpkg reset --hard FETCH_HEAD
          } elseif (Test-Path "C:\vcpkg\vcpkg.exe") {
            Write-Host "Using existing vcpkg install at C:\\vcpkg"
          } else {
            git clone --depth 1 https://github.com/microsoft/vcpkg.git C:\vcpkg
          }
          "VCPKG_ROOT=C:\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Restore vcpkg Cache
        id: cache-vcpkg
        uses: actions/cache@v4
        with:
          path: |
            C:\vcpkg\downloads
            C:\vcpkg\installed
            C:\vcpkg\packages
          key: windows-2019-vcpkg-x64-libpq-libzip-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: |
            windows-2019-vcpkg-x64-libpq-libzip-
            windows-2019-vcpkg-x64-

      - name: Install vcpkg Dependencies
        shell: pwsh
        run: |
          C:\vcpkg\bootstrap-vcpkg.bat -disableMetrics
          C:\vcpkg\vcpkg.exe install libpq:x64-windows libzip:x64-windows

      - name: Configure
        shell: pwsh
        run: |
          # Mirror setup.cmd/getrevision.cmd inputs used by win_build_msvc.cmd.
          $env:CGRU_VERSION = (Get-Content version.txt -Raw).Trim()
          $env:CGRU_REVISION = (git rev-parse HEAD).Trim()
          $env:AF_POSTGRESQL = "REQUIRED"
          $env:AF_OSTYPE = "windows"
          $env:AF_GUI = "YES"
          $env:AF_FERMER = "NO"
          $env:AF_PYTHON_INCLUDE_PATH = python -c "import sysconfig; print(sysconfig.get_path('include'))"
          $env:AF_PYTHON_LIBRARIES = python -c "import pathlib,sys; print(pathlib.Path(sys.base_prefix,'libs',f'python{sys.version_info[0]}{sys.version_info[1]}.lib'))"

          $vcpkgInstalled = "$env:VCPKG_ROOT\installed\x64-windows"

          cmake `
            -S afanasy/src/project.cmake `
            -B afanasy/src/project.cmake/build-win `
            -G "Visual Studio 16 2019" `
            -A x64 `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DCMAKE_PREFIX_PATH="$env:QT_ROOT" `
            -DPostgreSQL_INCLUDE_DIR="$vcpkgInstalled\include" `
            -DPostgreSQL_LIBRARY="$vcpkgInstalled\lib\libpq.lib"

      - name: Build
        shell: pwsh
        run: cmake --build afanasy/src/project.cmake/build-win --config Release -- /m
